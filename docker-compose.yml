# Docker Compose for UMDT E2E testing
# Creates mock-server and cli containers on a shared network

services:
  mock-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: umdt-mock-server
    command: ["python", "mock_server_cli.py", "start", "--config", "/app/docker/e2e_config.yaml", "--tcp-host", "0.0.0.0", "--tcp-port", "5020"]
    ports:
      - "5020:5020"
    volumes:
      - ./docker:/app/docker:ro
    networks:
      - umdt-net
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(1); s.connect(('localhost',5020)); s.close()"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: umdt-cli
    depends_on:
      mock-server:
        condition: service_healthy
    networks:
      - umdt-net
    # Keep container running for manual testing; E2E script runs separately
    command: ["sleep", "infinity"]

networks:
  umdt-net:
    driver: bridge
