# Wireshark Setup for UMDT

UMDT produces PCAP files with a specialized metadata header (User DLT 147) to differentiate between Upstream/Downstream and RTU/TCP traffic within a single capture. To decode these files correctly in Wireshark, you must install the provided Lua plugins.

## The Lua Scripts

Two scripts are provided in the root of the repository:
1.  `umdt_mbap.lua`: A helper dissector for Modbus Application Protocol (MBAP) headers and exception codes.
2.  `umdt_modbus_wrapper.lua`: The main wrapper that strips the UMDT metadata, handles RTU CRC removal, and hands off the packet to Wireshark's built-in Modbus dissector.

## Installation Methods

### Method 1: Temporary (One-Off)

You can load the scripts via command line arguments when launching Wireshark. This is useful for quick testing without modifying your Wireshark configuration.

**Windows (PowerShell):**
```powershell
& "C:\Program Files\Wireshark\Wireshark.exe" -X lua_script:umdt_modbus_wrapper.lua -X lua_script:umdt_mbap.lua
```

**Linux/macOS:**
```bash
wireshark -X lua_script:umdt_modbus_wrapper.lua -X lua_script:umdt_mbap.lua
```

### Method 2: Permanent Installation (Recommended)

Copy the two `.lua` files into your Wireshark "Personal Plugins" directory. Wireshark will load them automatically on startup.

**1. Find the Plugin Directory:**
*   Open Wireshark.
*   Go to **Help** -> **About Wireshark**.
*   Click the **Folders** tab.
*   Look for the path labeled **Personal Plugins** (or sometimes just "Plugins").
    *   *Windows*: Usually `%APPDATA%\Wireshark\plugins`
    *   *Linux*: `~/.local/lib/wireshark/plugins` or `~/.wireshark/plugins`
    *   *macOS*: `~/.config/wireshark/plugins`

**2. Copy Files:**
Copy `umdt_mbap.lua` and `umdt_modbus_wrapper.lua` into that directory. You may need to create the directory if it doesn't exist.

**3. Restart Wireshark:**
Close and reopen Wireshark. The plugins should now be active.

## Verifying Installation

To ensure the plugins are loaded:
1.  Open Wireshark.
2.  Go to **Analyze** -> **Enabled Protocols**.
3.  Search for `UMDT`. You should see `UMDT_Wrapper` checked.

## Analyzing PCAP Files

When you open a PCAP file generated by UMDT (`bridge.py` or `sniff_cli.py`):
1.  The protocol column should show `MODBUS` (or `TCP`/`RTU` depending on the inner traffic).
2.  Modbus Exceptions (e.g., Illegal Data Address) should appear highlighted in red or yellow.
3.  The Info column will show the direction (Upstream/Downstream) if the capture supports it.
